<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Email - Billings</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!--
        EMAIL VERIFICATION PAGE

        Purpose: Verify user's email address using token from email

        Flow:
        1. User clicks verification link in email with ?token=xyz
        2. Page auto-extracts token and verifies it
        3. Backend marks email as verified
        4. User redirected to dashboard
    -->

    <div class="container">
        <div class="form-container">
            <div class="form-header">
                <h1>üìß Email Verification</h1>
                <p id="status-message">Verifying your email...</p>
            </div>

            <!-- Status Area -->
            <div style="text-align: center; padding: 20px;">
                <!-- Loading -->
                <div id="loading" style="display: block;">
                    <p>‚è≥ Verifying your email address...</p>
                </div>

                <!-- Success -->
                <div id="success-message" class="success-message" style="display: none;">
                    <p>‚úì Email verified successfully!</p>
                    <p>Redirecting to dashboard...</p>
                </div>

                <!-- Error -->
                <div id="error-message" class="error-message" style="display: none;"></div>

                <!-- Action Buttons -->
                <div id="action-buttons" style="display: none; margin-top: 20px;">
                    <a href="dashboard.html" class="button button-primary">Go to Dashboard</a>
                    <a href="login.html" class="button">Login</a>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script type="module">
        import { API_FULL_BASE } from './js/config.js';

        const loading = document.getElementById('loading');
        const successMessage = document.getElementById('success-message');
        const errorMessage = document.getElementById('error-message');
        const actionButtons = document.getElementById('action-buttons');
        const statusMessage = document.getElementById('status-message');

        // Extract token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        // Auto-verify on page load
        async function verifyEmail() {
            // Check if token is present
            if (!token) {
                loading.style.display = 'none';
                errorMessage.textContent = 'Invalid verification link. No token provided.';
                errorMessage.style.display = 'block';
                actionButtons.style.display = 'block';
                statusMessage.textContent = 'Verification failed';
                return;
            }

            try {
                // Make API request
                const response = await fetch(`${API_FULL_BASE}/auth/verify-email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ token })
                });

                const data = await response.json();

                loading.style.display = 'none';

                if (response.ok) {
                    // Show success message
                    successMessage.style.display = 'block';
                    statusMessage.textContent = 'Email verified!';

                    // Redirect to dashboard after 2 seconds
                    setTimeout(() => {
                        const authToken = localStorage.getItem('token');
                        if (authToken) {
                            window.location.href = 'dashboard.html';
                        } else {
                            window.location.href = 'login.html';
                        }
                    }, 2000);
                } else {
                    // Show error message
                    errorMessage.textContent = data.detail || 'Failed to verify email';
                    errorMessage.style.display = 'block';
                    actionButtons.style.display = 'block';
                    statusMessage.textContent = 'Verification failed';
                }
            } catch (error) {
                loading.style.display = 'none';
                errorMessage.textContent = 'Network error. Please try again.';
                errorMessage.style.display = 'block';
                actionButtons.style.display = 'block';
                statusMessage.textContent = 'Verification failed';
                console.error('Error:', error);
            }
        }

        // Auto-run verification
        verifyEmail();
    </script>
</body>
</html>
